function outputImg = outline2ellipse(img,embOutline,template)
% img: the original image
% embOutline: estimated embryo outline from the segmentation algorithm
% template: the ellipse template
% parts of the code were adapted from SPEX2
[m,n] = size(template);

embRegion = poly2mask(embOutline(:,1),embOutline(:,2),m,n);
S = regionprops(embRegion, 'ConvexImage', 'BoundingBox');

embRegionConvex= S(1).ConvexImage;  % Convex-Hull smoothing
OutlineBoundingBox_one = max( ones(1,4), floor(S(1).BoundingBox));
% truncate to positive integers

S = regionprops(embRegionConvex, 'Orientation');
rotationAngle = -S(1).Orientation;
convexRegion = imrotate(embRegionConvex, rotationAngle, 'bilinear', 'loose');
imgTemp = img(OutlineBoundingBox_one(2) + (0:OutlineBoundingBox_one(4)-1), OutlineBoundingBox_one(1) + (0:OutlineBoundingBox_one(3)-1), :);  
imgTemp = imrotate(double(imgTemp), rotationAngle, 'bilinear', 'loose');

convexRegion = imresize(convexRegion, [size(convexRegion, 1), size(template,2)], 'nearest');
imgTemp = imresize(imgTemp, [size(imgTemp, 1), size(template,2)], 'nearest');% resize the region to match the width of the template

outputImg = zeros(size(template));
for j = 1 : size(template,2)
    if any(convexRegion(:,j))     
        outputImg(template(:,j)~=0,j) = imresize(imgTemp((convexOutline(:,j)~=0), j), [sum(template(:,j)), 1], 'nearest');
        % morphing the vertical dimension only...
    end;
end;

outputImg(~template) = 0;
displayMorphedGreyScaleImage = 1-imadjust(morphedGreyScaleImage); % we have adjusted the contrast in the image to better visualize it.
morphedGreyScaleImage = 1 - morphedGreyScaleImage;
